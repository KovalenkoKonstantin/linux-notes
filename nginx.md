Для установки и настройки Nginx на Ubuntu в VirtualBox для использования с Flask-приложением, мы пройдем через несколько шагов. В этой инструкции я объясню, как установить и настроить Nginx, настроить Flask для работы через Nginx и убедиться, что каждый шаг выполняется правильно.

### Шаг 1: Установка Nginx

1. **Обновите пакеты системы:**

   Сначала нужно обновить список доступных пакетов и обновить установленные:

   ```bash
   sudo apt update
   sudo apt upgrade -y
   ```

2. **Установите Nginx:**

   Для установки Nginx используйте следующую команду:

```bash
sudo apt install nginx -y
```

   Проверка: чтобы убедиться, что Nginx установлен, выполните команду:

```bash
nginx -v
```

   Эта команда должна вывести версию Nginx, например:

```
nginx version: nginx/1.24.0 (Ubuntu)
```

3. **Проверьте, что Nginx работает:**

   Nginx автоматически запустится после установки. Проверьте, что сервис работает:

```bash
sudo systemctl status nginx
```

   Вы должны увидеть, что статус сервиса "active (running)". Если это не так, используйте команду для старта:

```bash
sudo systemctl start nginx
```

### Шаг 2: Настройка Flask-приложения для работы с Nginx

1. **Убедитесь, что ваше Flask-приложение работает:**

   Для начала проверьте, что Flask-приложение запускается без Nginx:

   - Перейдите в директорию с вашим приложением (например, `/var/www/local.work`).
   - Активируйте виртуальное окружение:

```bash
source /var/www/venv/bin/activate
```

   - Запустите Flask-приложение:

```bash
python app.py
```

   Flask должен начать работать на адресах `127.0.0.1:5000` и `10.121.1.24:5000`. Проверьте, что приложение доступно по этим адресам в браузере. Убедитесь, что оно работает корректно.

2. **Настройте Gunicorn для Flask:**

   Nginx будет проксировать запросы на сервер Flask, работающий через WSGI-сервер Gunicorn.

   Установите Gunicorn:

```bash
pip install gunicorn
```

   Проверка: убедитесь, что Gunicorn установлен, проверив его версию:

```bash
gunicorn --version
```

   Теперь запустите Flask-приложение через Gunicorn:

```bash
gunicorn --bind 127.0.0.1:5000 app:app
```

   Проверка: убедитесь, что приложение доступно по адресу `127.0.0.1:5000` через Gunicorn, используя браузер.

### Шаг 3: Настройка Nginx для проксирования запросов на Flask

1. **Создайте конфигурацию для сайта в `sites-available`:**

   В каталоге `/etc/nginx/sites-available/` создайте новый файл конфигурации для вашего сайта:

```bash
sudo nano /etc/nginx/sites-available/local.work
```

   Вставьте следующую конфигурацию:

```nginx
server {
    listen 80;
    server_name 10.121.1.24;  # Укажите ваш IP или доменное имя

    location / {
        proxy_pass http://127.0.0.1:8001;  # Прокси на Flask через Gunicorn
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static/ {
        alias /var/www/local.work/static/;  # Путь к статическим файлам
    }
}
   ```

   Проверьте конфигурацию на наличие синтаксических ошибок:

```bash
sudo nginx -t
```

   Если ошибок нет, вы увидите:

```bash
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

2. **Активируйте конфигурацию сайта:**

   Чтобы включить сайт, создайте символическую ссылку в `sites-enabled`:

```bash
sudo ln -s /etc/nginx/sites-available/local.work /etc/nginx/sites-enabled/
```

   Проверьте, что конфигурация корректно активирована:

```bash
ls -l /etc/nginx/sites-enabled/
```

   Вы должны увидеть символическую ссылку на файл конфигурации.

```bash
lrwxrwxrwx 1 root root 37 Apr 24 13:49 local.work -> /etc/nginx/sites-available/local.work
```


3. **Перезапустите Nginx:**

   Перезапустите Nginx для применения изменений:

```bash
sudo systemctl restart nginx
```

   Проверка: убедитесь, что сервис Nginx перезапустился без ошибок, используя команду:

```bash
sudo systemctl status nginx
```

### Шаг 4: Тестирование конфигурации

1. **Проверьте доступность сайта через Nginx:**

   Откройте браузер и перейдите по адресу `http://10.121.1.24/` (или вашему IP-адресу). Если все настроено правильно, вы должны увидеть страницу вашего Flask-приложения.

2. **Проверьте доступность статических файлов:**

   Попробуйте получить доступ к статическим файлам (например, CSS или изображениям) по адресу `http://10.121.1.24/static/` и убедитесь, что они корректно загружаются.

3. **Проверьте логи Nginx на наличие ошибок:**

   Если возникнут проблемы, проверяйте логи Nginx:

   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

   Это поможет вам быстро выявить возможные ошибки в конфигурации.

### Шаг 5: Защита соединения с помощью SSL (опционально)

Для обеспечения безопасности стоит настроить SSL с использованием Let's Encrypt. Однако для начала Nginx уже будет работать без SSL. Чтобы настроить SSL:

1. **Установите Certbot:**

   ```bash
   sudo apt install certbot python3-certbot-nginx
   ```

2. **Запустите Certbot для получения сертификата:**

   ```bash
   sudo certbot --nginx -d your_domain.com
   ```

   Certbot автоматически настроит SSL для вашего сайта.

3. **Проверьте автоматическое обновление сертификатов:**

   Certbot настроит автоматическое обновление сертификатов. Чтобы проверить его работу:

   ```bash
   sudo systemctl status certbot.timer
   ```

### Заключение

Теперь ваш сервер Flask должен работать через Nginx, и все запросы будут проксироваться на Flask-приложение через Gunicorn. Убедитесь, что все шаги выполнены правильно, и протестируйте конфигурацию, чтобы убедиться, что сайт доступен, а статические файлы загружаются корректно.

Если возникнут проблемы, проверьте логи Nginx и Gunicorn, чтобы получить больше информации о возможных ошибках.