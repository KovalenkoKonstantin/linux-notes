# 15. Процессы №2 Информация о процессах №2

**Процессы №2: Информация о процессах**

Процесс — это исполнимая программа в операционной системе, которая выполняет определённые задачи, используя ресурсы системы, такие как процессор и оперативную память. Обычно процессы появляются, выполняют свою работу и завершаются без необходимости вмешательства администратора. Однако иногда процессы могут зависать или потреблять слишком много ресурсов, что приводит к зависанию системы или других процессов. В таких случаях администратору нужно вмешаться. Рассмотрим, как можно диагностировать проблемы с процессами и ресурсоёмкими задачами.

### Утилита `top`

Для мониторинга процессов и их ресурсов можно использовать утилиту `top`. Она позволяет отслеживать состояние системы в реальном времени, включая информацию о процессах, загрузке процессора, использовании памяти и другие данные.

1. **Интерфейс утилиты `top`**:
   При запуске `top` появляется несколько строк с общей информацией о системе и процессах. Рассмотрим важные части этой информации:

   - **Первая строка**: Общая информация о системе:
     - Текущее время
     - Время работы системы
     - Средняя нагрузка (по минутам: 1 минута, 5 минут, 15 минут)
     - Количество пользователей (user)
     - Количество процессов

     Пример:
     ```
     top - 15:30:02 up 1:45, 2 users, load average: 0.56, 0.78, 0.90
     ```

   - **Вторая строка**: Статистика по процессам:
     - Общее количество процессов
     - Сколько процессов активно, сколько спят, а сколько остановлены
     - Количество "зомби" процессов — это процессы, завершившие выполнение, но не удалённые из таблицы процессов, так как их родительский процесс не прочитал их статус.

     Пример:
     ```
     Tasks: 234 total, 1 running, 233 sleeping, 0 stopped, 0 zombie
     ```

   - **Третья строка**: Использование процессора:
     - `us`: время процессора, потраченное на программы в пользовательском пространстве (user space)
     - `sy`: время процессора, потраченное на операции ядра (kernel space)
     - `ni`: время, потраченное на процессы с низким приоритетом (niceness)
     - `id`: время, когда процессор был в режиме ожидания (idle)
     - `wa`: время, когда процессор ждал ввода/вывода (I/O wait)
     - `hi`: время, затраченное на аппаратные прерывания
     - `si`: время, затраченное на программные прерывания
     - `st`: время, когда виртуальная машина "крадёт" ресурсы (steal time)

     Пример:
     ```
     %Cpu(s): 23.4 us, 15.6 sy, 0.0 ni, 45.7 id, 5.0 wa, 0.3 hi, 0.1 si, 0.0 st
     ```

   - **Четвёртая строка**: Использование памяти:
     - `total`: Общее количество памяти
     - `free`: Свободная память
     - `used`: Используемая память
     - `buff/cache`: Память, используемая под кэш

     Пример:
     ```
     MiB Mem : 16384 total, 3203 free, 10325 used, 3856 buff/cache
     ```

   - **Пятая строка**: Использование swap-памяти:
     Swap — это область на жестком диске (или SSD), используемая системой, когда оперативная память (RAM) заканчивается. Swap позволяет сохранять данные, которые не помещаются в физическую память, в файл или разделе на диске. Это помогает предотвратить сбои, когда физическая память исчерпана.
     Пример:
     ```
     MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.   4633.4 avail Mem
     ```
     - **total** — общее количество swap-памяти (2048 MiB).
     - **free** — сколько swap-памяти свободно (2048 MiB).
     - **used** — сколько swap-памяти используется (0.0 MiB).
     - **avail Mem** — доступная память в системе (с учетом как оперативной памяти, так и swap-памяти, доступной для новых процессов).

2. **Столбцы в выводе `top`**:
   В таблице процессов выводятся следующие основные столбцы:
   - **PID**: Идентификатор процесса
   - **USER**: Пользователь, который запустил процесс
   - **PR**: Приоритет процесса в ядре
   - **NI**: Значение "вежливости" процесса (niceness)
   - **VIRT**: Объём виртуальной памяти, используемой процессом
   - **RES**: Объём реальной памяти, используемой процессом
   - **SHR**: Общая память, разделяемая процессами
   - **S**: Статус процесса: `S` (спит), `R` (работает), `Z` (зомби), и другие
   - **CPU**: Процент использования процессора данным процессом
   - **TIME+**: Общее время процессора, потраченное на этот процесс

   Пример таблицы:
   ```
   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
   1234 user1     20   0  156436  23456   3568 S   5.0  0.1   0:05.23 firefox
   ```

### Как управлять процессами

1. **Ограничение ресурсов**:
   Можно ограничить количество процессов или ресурсов (например, оперативной памяти), которые может использовать пользователь. Для этого используется команда `ulimit`.

   Пример:
   - Ограничение количества процессов:
     ```
     ulimit -u 1024
     ```
   - Ограничение использования памяти:
     ```
     ulimit -v 1048576  # в килобайтах
     ```

2. **Остановка процессов**:
   В случае, если какой-то процесс использует слишком много ресурсов, его можно остановить с помощью команды `kill`. Чтобы узнать PID (идентификатор процесса), используйте команду `ps` или `top`.

   Пример:
   ```
   kill -9 1234  # Остановить процесс с PID 1234
   ```
    * -9 — это сигнал **SIGKILL**. Он принудительно завершает процесс.
    * Сигнал **SIGKILL** (код 9) является самым "жестким" способом завершения процесса. Он немедленно завершает процесс, не давая ему возможности обработать завершение, очистить ресурсы или выполнить какие-либо другие действия.
    * В отличие от других сигналов, например **SIGTERM** (по умолчанию сигнал, посылаемый командой `kill` без параметров), который позволяет процессу корректно завершиться (например, освободить ресурсы), **SIGKILL** не дает процессу выбора, и тот немедленно завершится.

    ```bash
    ps -p 578               # Проверка, работает ли процесс
    kill -9 578             # Завершение процесса
    ps -p 578               # Повторная проверка, завершен ли процесс
    ```
    Дополнительно, вы можете использовать команду pgrep, чтобы подтвердить, что процесс **с этим PID** больше не существует:
    ```bash
    pgrep -f systemd-journal
    ```

3. **Использование `htop`**:
   `htop` — это более интерактивный аналог утилиты `top`, который позволяет использовать мышь и удобный интерфейс для работы с процессами. Например, в `htop` можно:
   - Сортировать процессы по CPU или памяти
   - Изменять приоритет процесса (niceness)
   - Убивать процессы (kill)
   - Просматривать процессы в древовидной структуре

   Чтобы установить `htop`:
   ```
   sudo yum install htop -y
   sudo htop
   ```

   В `htop` можно легко изменить приоритет процесса с помощью клавиш **F7** (уменьшить) и **F8** (увеличить). Для убивания процесса используйте клавишу **F9**.
   Значения **niceness** могут быть в пределах от **-20** (максимальный приоритет) до **+19** (минимальный приоритет). Процесс с более низким значением **niceness** имеет более высокий приоритет.


### Дополнительные настройки

1. **Лимитирование процессов**:
   Ограничение на количество процессов для пользователей можно установить в файле `/etc/security/limits.conf`. Это защитит систему от чрезмерного использования ресурсов одним пользователем.

   Пример настройки:
   ```
   <domain>      <type>  <item>         <value>
    *               soft    core            0
    *               hard    rss             10000
    @student        hard    nproc           20
    @faculty        soft    nproc           20
    @faculty        hard    nproc           50
    ftp             hard    nproc           0
    @student        -       maxlogins       4
   ```
* **домен** — к кому применяется правило (например, пользователь, группа пользователей с `@`, или все `*`);
* **тип** — `soft` или `hard` лимит:
    * `soft` — ограничение, которое пользователь может изменить сам (в пределах `hard`);
    * `hard` — максимальное ограничение, которое пользователь не может превысить без прав администратора;
* **ресурс** — какой именно ресурс ограничивается (`core`, `rss`, `nproc`, `maxlogins`);
* **значение** — численное значение ограничения.

### Что означают:

| Название  | Что это означает | Пояснение |
|:----------|:-----------------|:-----------|
| **core** | Размер core-файла | Core-файл — это файл, который создается системой при крахе (падении) программы. Он содержит снимок памяти процесса. Лимит `core` определяет, можно ли сохранять такие файлы и какого они могут быть размера. Если `core = 0`, дампы памяти запрещены. |
| **rss** | Resident Set Size (размер оперативной памяти процесса) | Ограничивает объем физической памяти (RAM), который может использовать процесс. Это предотвращает "съедание" всей оперативки одним пользователем или программой. Измеряется в килобайтах. |
| **nproc** | Number of processes (число процессов) | Максимальное количество процессов, которые может создать пользователь. Это важно для защиты от атак, когда пользователь может попытаться перегрузить систему (например, бесконечным созданием процессов — fork-бомбой). |
| **maxlogins** | Максимум одновременных сессий | Ограничивает, сколько раз один и тот же пользователь может одновременно быть залогинен в систему (например, по SSH, в консоли и т.д.). |

2. **Зомби-процессы**:
   Зомби-процессы появляются, когда дочерний процесс завершился, но его родительский процесс ещё не прочитал код завершения. Если слишком много таких процессов, это может привести к переполнению таблицы процессов. Вы можете использовать команду `ps aux | grep Z`, чтобы найти зомби-процессы.

### Заключение

Утилиты, такие как `top` и `htop`, позволяют отслеживать и управлять процессами в Linux. Понимание их работы помогает эффективно использовать ресурсы системы и предотвращать зависания из-за перегрузки процессора или памяти.

### Практика и вопросы

#### 1. Запустите `top` и объясните значения каждого столбика и строчки

Когда вы запускаете команду `top`, она выводит информацию о текущем состоянии процессов в системе. Вот основные параметры:

- **PID (Process ID)**: Идентификатор процесса.
- **USER**: Пользователь, который запустил процесс.
- **PR (Priority)**: Приоритет процесса в ядре. Чем выше значение, тем меньше приоритет.
- **NI (Nice value)**: Вежливость процесса, которая определяет, как процесс будет использовать процессорное время. Процесс с более высоким значением будет иметь меньший приоритет.
- **VIRT (Virtual Memory)**: Виртуальная память, которую процесс использует. Это включает в себя как физическую память, так и память, которая может быть размещена на диске.
- **RES (Resident Memory)**: Реальная память (RAM), которую процесс использует в данный момент.
- **SHR (Shared Memory)**: Сколько из виртуальной памяти может быть разделено с другими процессами.
- **S (Status)**: Статус процесса. Например:
  - `S` — спящий процесс.
  - `R` — процесс в работе.
  - `Z` — зомби процесс.
- **CPU (CPU usage)**: Процент времени, которое процессор тратит на выполнение данного процесса. Обратите внимание, что это может превышать 100%, если у вас многоядерный процессор.
- **MEM (Memory usage)**: Процент памяти, который процесс использует от всей доступной.
- **TIME+**: Время, которое процесс уже использует процессор.

#### 2. Что такое зомби процессы?

Зомби-процесс — это процесс, который завершил своё выполнение, но его запись всё ещё остается в таблице процессов. Это происходит, когда родительский процесс не прочитал статус завершения дочернего процесса. Зомби процессы не используют ресурсы системы, но они остаются в таблице процессов, пока родитель не получит информацию о завершении.

#### 3. Как запретить пользователю запускать слишком много процессов и зачем это нужно?

Ограничение на количество процессов для пользователей ставится для предотвращения ситуации, когда один пользователь запустит слишком много процессов, что может привести к перегрузке системы. Это важно, чтобы предотвратить возможные сбои или зависания системы.

Чтобы ограничить количество процессов у пользователя:

1. Откройте файл `/etc/security/limits.conf` и добавьте строку:
   ```
   username    hard    nproc    500
   ```
   Где `username` — это имя пользователя, для которого вы хотите установить ограничение, а `500` — максимальное количество процессов, которое он может запустить.

2. Также можно задать это ограничение в файле `~/.bash_profile`:
   ```
   ulimit -u 500
   ```

### Задания

#### 1. Запустите форк-бомбу

Форк-бомба — это скрипт, который создает новые процессы до тех пор, пока не исчерпает все ресурсы системы. Запуск форк-бомбы приведет к тому, что система начнёт исчерпывать доступные процессы, и она может зависнуть.

Запустите форк-бомбу с помощью следующей команды:
```bash
:(){ :|:& };:
```
Команда `:(){ :|:& };:` — это печально известная **"fork-бомба"** в Unix/Linux. Она выглядит как криптографическая загадка, но её поведение очень простое — **она за несколько секунд "забивает" систему**, создавая тысячи процессов.

---

### 🔍 Построчное объяснение:

```bash
:(){        # создаём функцию с именем ":" (да, это разрешено в bash)
  :|:       # она вызывает сама себя дважды, передавая вывод одной в другую (пайп)
  &         # и запускается в фоне
};          # конец определения функции
:           # вызов функции, т.е. запуск fork-бомбы
```

---

### 🔥 Что делает эта команда:

1. Создается функция `:` (имя функции — двоеточие).
2. Эта функция запускает **две копии самой себя**:
   - через пайп `:|:` — создаёт ветвление;
   - `&` — отправляет их в фоновый режим.
3. Эти дочерние процессы запускают ещё больше копий — **экспоненциальный рост**.
4. Через несколько секунд система достигает **лимита процессов (nproc)** → она **"зависает"** или становится нестабильной.
5. Иногда помогает только **жесткая перезагрузка**.

---

### ⚠️ Почему это опасно:
- Этот однострочник используется как **DoS-атака на систему**, особенно если лимит процессов (`nproc`) не настроен.
- Даже обычный пользователь может потенциально "положить" сервер, если нет ограничений.

---

### 🛡 Как защититься:
- Установить лимит на количество процессов для пользователей в `/etc/security/limits.conf`:
  ```bash
  username   hard    nproc   100
  ```
- Или глобально в `/etc/security/limits.d/` или через `ulimit`.

---

#### 2. Перезагрузите виртуальную машину

После того как система зависнет из-за форк-бомбы, перезагрузите виртуальную машину, чтобы очистить все процессы.

#### 3. Ограничьте количество процессов для своего пользователя

После перезагрузки системы, откройте файл `/etc/security/limits.conf` и добавьте строку для ограничения процессов:
```bash
username    hard    nproc    500
```

Затем снова запустите форк-бомбу:
```bash
:(){ :|:& };:
```

#### Результат:

- В первом случае, когда ограничения на количество процессов нет, форк-бомба вызовет зависание всей системы, поскольку будет создано слишком много процессов.
- Во втором случае, когда количество процессов ограничено до 500, форк-бомба затронет только процессы пользователя, и система останется работоспособной для других пользователей.

После того как вы запустите форк-бомбу, попробуйте залогиниться от другого пользователя, чтобы увидеть, как система работает в условиях ограничений.

---

Это отличный способ практики для понимания того, как ограничения на ресурсы помогают защитить систему от сбоев и перегрузок.