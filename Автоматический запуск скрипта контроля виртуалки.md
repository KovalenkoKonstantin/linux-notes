# üöÄ –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–∏—Ä—Ç—É–∞–ª–∫–∏

---

## –®–∞–≥ 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º PowerShell-—Å–∫—Ä–∏–ø—Ç

1. –û—Ç–∫—Ä–æ–π **–ë–ª–æ–∫–Ω–æ—Ç** (–∏–ª–∏ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä).
2. –í—Å—Ç–∞–≤—å —Ç—É–¥–∞ –≤–µ—Å—å –∫–æ–¥:.

```bash
# –ß—Ç–æ–±—ã PowerShell –Ω–µ —Ä—É–≥–∞–ª—Å—è –Ω–∞ "–∑–∞–ø—Ä–µ—â–µ–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã".
#Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω—Å–æ–ª–∏
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
$vmName = "clone"                                           # –∏–º—è –≤–∏—Ä—É—Ç–∞–ª–∫–∏
$vboxManagePath = "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe"
$diskPath = "w:\.conf_backup\web"                           # –ü—É—Ç—å –∫ —Å–µ—Ç–µ–≤–æ–º—É –¥–∏—Å–∫—É
$vmIP = "10.121.1.24"                                       # IP –≤–∏—Ä—Ç—É–∞–ª–∫–∏
$checkIntervalSeconds = 60                                  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
$logFile = "C:\Logs\vm_monitor.log"                         # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–∞

# –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –ø–∞–ø–∫–∞ –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å—Ç—å
if (-not (Test-Path (Split-Path $logFile))) {
	New-Item -ItemType Directory -Path (Split-Path $logFile) | Out-Null
}

function Write-Log {
	param ([string]$message)
	$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
	$fullMessage = "$timestamp - $message"
	Write-Host $fullMessage
	Add-Content -Path $logFile -Value $fullMessage
	#$fullMessage | Out-File -FilePath $logFile -Encoding utf8 -Append
}

Write-Log "=== –°—Ç–∞—Ä—Ç —Å–∫—Ä–∏–ø—Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–∏—Ä—Ç—É–∞–ª–∫–∏ ==="

# –û–±—ë—Ä—Ç–∫–∞-–∑–∞—â–∏—Ç–∞
while ($true) {
    try {
		# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ç–µ–≤–æ–≥–æ –¥–∏—Å–∫–∞
		if (-not (Test-Path $diskPath)) {
			Write-Log "–°–µ—Ç–µ–≤–æ–π –¥–∏—Å–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∂–¥—ë–º $checkIntervalSeconds —Å–µ–∫—É–Ω–¥..."
			Start-Sleep -Seconds $checkIntervalSeconds
			continue
		}

		# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è VBoxManage
		if (-not (Test-Path $vboxManagePath)) {
			Write-Log "VBoxManage.exe –Ω–µ –Ω–∞–π–¥–µ–Ω! –ñ–¥—ë–º $checkIntervalSeconds —Å–µ–∫—É–Ω–¥..."
			Start-Sleep -Seconds $checkIntervalSeconds
			continue
		}

		# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤–∏—Ä—Ç—É–∞–ª–∫–∏
		$ping = Test-Connection -ComputerName $vmIP -Count 1 -Quiet -ErrorAction SilentlyContinue

		if (-not $ping) {
			Write-Log "–í–∏—Ä—Ç—É–∞–ª–∫–∞ $vmName –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç! –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫..."

			# –§–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ
			Write-Log "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª–∫—É..."
			& "$vboxManagePath" controlvm "$vmName" poweroff
			Start-Sleep -Seconds 10

			# –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞
			Write-Log "–ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª–∫—É..."
			& "$vboxManagePath" startvm "$vmName" --type headless

			if ($LASTEXITCODE -eq 0) {
				Write-Log "–í–∏—Ä—Ç—É–∞–ª–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ."
			} else {
				Write-Log "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–∏—Ä—Ç—É–∞–ª–∫–∏! –ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞: $LASTEXITCODE"
			}
		}

		# 4. –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
		Start-Sleep -Seconds $checkIntervalSeconds
		
	} catch {
		Write-Log "–û—à–∏–±–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞: $($_.Exception.Message). –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥."
		Start-Sleep -Seconds 10
    }
}
```

3. –°–æ—Ö—Ä–∞–Ω–∏ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º **`.ps1`**, –Ω–∞–ø—Ä–∏–º–µ—Ä:

> `C:\Scripts\clone_vm.ps1`

*(–°–æ–∑–¥–∞–π –ø–∞–ø–∫—É `C:\Scripts`, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç ‚Äî –¥–ª—è –ø–æ—Ä—è–¥–∫–∞)*

‚úÖ –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å —Å–∫—Ä–∏–ø—Ç PowerShell.

---

## –®–∞–≥ 2. –°–æ–∑–¥–∞—ë–º BAT-—Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞

1. –û—Ç–∫—Ä–æ–π –Ω–æ–≤—ã–π **–ë–ª–æ–∫–Ω–æ—Ç**.
2. –í—Å—Ç–∞–≤—å –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```bat
@echo off
powershell.exe -ExecutionPolicy Bypass -File "C:\Scripts\clone_vm.ps1"
```

> ‚ùó –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: –ø—É—Ç—å `"C:\Scripts\clone_vm.ps1"` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, –≥–¥–µ —Ç—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª `.ps1` —Ñ–∞–π–ª.

3. –°–æ—Ö—Ä–∞–Ω–∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º **`.bat`**, –Ω–∞–ø—Ä–∏–º–µ—Ä:

> `C:\Scripts\start_vm_clone.bat`

‚úÖ –£ –Ω–∞—Å —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –±–∞—Ç–Ω–∏–∫ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ PowerShell-—Å–∫—Ä–∏–ø—Ç–∞ –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ –ø–æ–ª–∏—Ç–∏–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

---

## –®–∞–≥ 3. –î–æ–±–∞–≤–ª—è–µ–º –±–∞—Ç–Ω–∏–∫ –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É

–¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏–º —Ç–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–∏—Ä—Ç—É–∞–ª–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Windows.

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –ø–∞–ø–∫—É "–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞" (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±)

1. –ù–∞–∂–º–∏ `Win + R`, –≤–≤–µ–¥–∏:

> `shell:startup`

–ò –Ω–∞–∂–º–∏ **Enter**.  
–û—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–∞–ø–∫–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

2. –ö–æ–ø–∏—Ä—É–π —Ç—É–¥–∞ —è—Ä–ª—ã–∫ –Ω–∞ –Ω–∞—à –±–∞—Ç–Ω–∏–∫:

- –ö–ª–∏–∫–Ω–∏ **–ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π** –Ω–∞ `start_vm_clone.bat`.
- –í—ã–±–µ—Ä–∏ **–°–æ–∑–¥–∞—Ç—å —è—Ä–ª—ã–∫**.
- –ü–µ—Ä–µ–Ω–µ—Å–∏ —ç—Ç–æ—Ç —è—Ä–ª—ã–∫ –≤ –æ—Ç–∫—Ä—ã–≤—à—É—é—Å—è –ø–∞–ø–∫—É –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏.

‚úÖ –¢–µ–ø–µ—Ä—å —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã!

---

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–Ω–∏–π (–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–ª –¥–∞–∂–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ (–¥–æ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è), —Ç–æ–≥–¥–∞:

1. –û—Ç–∫—Ä–æ–π **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–Ω–∏–π** (`Task Scheduler`):
   - –ù–∞–∂–º–∏ `Win`, –≤–≤–µ–¥–∏ **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–Ω–∏–π**, –æ—Ç–∫—Ä–æ–π –µ–≥–æ.

2. –ù–∞–∂–º–∏ **–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É** (–Ω–µ "–ü—Ä–æ—Å—Ç—É—é –∑–∞–¥–∞—á—É").

3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∫–ª–∞–¥–∫–∏ **–û–±—â–∏–µ**:
   - –ù–∞–∑–≤–∞–Ω–∏–µ: `VM Monitor`
   - –ü–æ—Å—Ç–∞–≤—å –≥–∞–ª–∫—É **"–í—ã–ø–æ–ª–Ω—è—Ç—å —Å –Ω–∞–∏–≤—ã—Å—à–∏–º–∏ –ø—Ä–∞–≤–∞–º–∏"**.
   - –í—ã–±–µ—Ä–∏ "Windows 10" –≤ "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è".

4. –í–∫–ª–∞–¥–∫–∞ **–¢—Ä–∏–≥–≥–µ—Ä—ã**:
   - –ù–∞–∂–º–∏ **–°–æ–∑–¥–∞—Ç—å** ‚ûî **–ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É**.

5. –í–∫–ª–∞–¥–∫–∞ **–î–µ–π—Å—Ç–≤–∏—è**:
   - –ù–∞–∂–º–∏ **–°–æ–∑–¥–∞—Ç—å**:
     - –î–µ–π—Å—Ç–≤–∏–µ: **–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã**
     - –ü—Ä–æ–≥—Ä–∞–º–º–∞: `powershell.exe`
     - –ê—Ä–≥—É–º–µ–Ω—Ç—ã:

       ```
       -ExecutionPolicy Bypass -File "C:\Scripts\clone_vm.ps1"
       ```

6. –ì–æ—Ç–æ–≤–æ! –ñ–º–∏ **–û–ö**.

‚úÖ –¢–µ–ø–µ—Ä—å —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ü–∞—Ä—å: —Å—Ç–∞–±–∏–ª—å–Ω–æ, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

---

# üéØ –ö—Ä–∞—Ç–∫–∞—è –≤—ã–∂–∏–º–∫–∞

| –®–∞–≥        | –ß—Ç–æ –¥–µ–ª–∞–µ–º                               |
|------------|------------------------------------------|
| 1 | –°–æ—Ö—Ä–∞–Ω—è–µ–º PowerShell —Å–∫—Ä–∏–ø—Ç (`.ps1`) |
| 2 | –î–µ–ª–∞–µ–º `.bat` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ |
| 3 | –ö–∏–¥–∞–µ–º —è—Ä–ª—ã–∫ –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –∑–∞–¥–∞—á—É –≤ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ |

---

# üî• –ë–æ–Ω—É—Å: –ª–∞–π—Ñ—Ö–∞–∫–∏

- **–õ–æ–≥–∏** –≤ `C:\Logs\vm_monitor.log` –º–æ–∂–Ω–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —á–∏—Å—Ç–∏—Ç—å –±–∞—Ç–Ω–∏–∫–æ–º —á–µ—Ä–µ–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.
- –ï—Å–ª–∏ –±—É–¥–µ—Ç –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∏—Ä—Ç—É–∞–ª–æ–∫ ‚Äî –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —á—É—Ç—å —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å–∫—Ä–∏–ø—Ç.
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ—á—Ç—É –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –≤–∏—Ä—Ç—É–∞–ª–∫–∏ ‚Äî –µ—Å–ª–∏ –Ω–∞–¥–æ, —Å–∫–∞–∂–∏, —Ä–∞—Å—Å–∫–∞–∂—É –∫–∞–∫. üìß

